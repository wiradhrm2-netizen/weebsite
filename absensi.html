<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Absensi Siswa</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
<script src="https://unpkg.com/html5-qrcode"></script>
<link rel="stylesheet" href="style.css">
<style>
body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #f5f7ff, #e0ebff);
    display: flex;
    justify-content: center;
    padding: 30px;
}
.card {
    background: #fff;
    padding: 30px 40px;
    border-radius: 20px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 500px;
}
input, select, button {
    width: 100%;
    margin: 10px 0;
    padding: 12px;
    border-radius: 10px;
    border:1px solid #ccc;
    font-size: 15px;
}
button {
    cursor:pointer;
    font-weight:600;
    transition:0.3s;
}
button#kirimManual { background:#346dff; color:#fff; }
button#kirimManual:hover { background:#1a52d1; }
button#backBtn { background:#999; color:#fff; }
button#backBtn:hover { background:#666; }
.success {
    display:none;
    position:fixed;
    top:20px;
    left:50%;
    transform:translateX(-50%);
    background:#4caf50;
    color:#fff;
    padding:15px 30px;
    border-radius:10px;
    box-shadow:0 5px 15px rgba(0,0,0,0.2);
    z-index:1000;
    font-weight:600;
    text-align:center;
}
.notif {
    position:fixed;
    bottom:25px;
    left:50%;
    transform:translateX(-50%) scale(0.8);
    background:rgba(255,80,80,0.95);
    color:#fff;
    padding:14px 22px;
    border-radius:14px;
    font-size:15px;
    font-weight:600;
    box-shadow:0 4px 15px rgba(0,0,0,0.15);
    opacity:0;
    transition:0.35s;
    pointer-events:none;
    text-align:center;
}
.notif.show {
    opacity:1;
    transform:translateX(-50%) scale(1);
}
</style>
</head>
<body>
<div class="card">
    <h1>Absensi Siswa</h1>

    <h2>Scan QR</h2>
    <!-- Dropdown pilih kamera -->
    <select id="pilihKamera" style="width:100%;padding:10px;margin-bottom:10px;border-radius:10px;">
        <option value="">Memuat kamera...</option>
    </select>

    <div id="reader"></div>
    <p id="scanStatus" style="font-size:14px;color:#555">Mengaktifkan kamera...</p>

    <h2>Isi Manual</h2>
    <input id="manualId" placeholder="NIS" autocomplete="off" />
    <input id="manualNama" placeholder="Nama Lengkap" />
    <input id="manualKelas" placeholder="Kelas (misal 8A)" />
    <select id="manualStatus">
        <option value="Hadir">Hadir</option>
        <option value="Izin">Izin</option>
        <option value="Sakit">Sakit</option>
    </select>
    <input id="manualKet" placeholder="Keterangan (opsional)" />

    <button id="kirimManual">Kirim Absen</button>
    <button id="backBtn">Kembali</button>
</div>

<div id="successMsg" class="success">✅ Absensi Berhasil</div>
<div id="notif" class="notif">⚠️ Silahkan mengisi terlebih dahulu</div>

<script>
let sudahAbsen = false;
const beep = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");

function kembaliKeLanding() {
    window.location.href = "index.html";
}

function showSuccess() {
    const s = document.getElementById("successMsg");
    s.style.display = "block";
    beep.play();
    setTimeout(() => {
        s.style.display = "none";
        kembaliKeLanding();
    }, 2000);
}

function showNotif(msg) {
    const n = document.getElementById("notif");
    n.innerText = msg;
    n.classList.add("show");
    setTimeout(() => n.classList.remove("show"), 2000);
}

function kunciForm() {
    document.querySelectorAll("input, select, button#kirimManual").forEach(el => el.disabled = true);
}

/* ===== SCAN QR DENGAN PILIH KAMERA ===== */
const reader = new Html5Qrcode("reader");
let daftarKamera = [];

// Ambil semua kamera
Html5Qrcode.getCameras().then(cameras => {
    daftarKamera = cameras;
    const select = document.getElementById("pilihKamera");
    select.innerHTML = "";

    cameras.forEach(cam => {
        const option = document.createElement("option");
        option.value = cam.id;
        option.text = cam.label || cam.id;
        select.appendChild(option);
    });

    if(cameras.length > 0){
        mulaiScan(cameras[0].id); // default kamera pertama
    }
});

function mulaiScan(cameraId){
    reader.stop().catch(()=>{});
    reader.start(
        cameraId,
        { fps: 10, qrbox: 250 },
        qr => {
            if(sudahAbsen) return;
            if(!qr || qr.trim() === ""){
                showNotif("⚠️ QR kosong, silahkan scan ulang");
                return;
            }

            const parts = qr.split('|');
            if(parts.length < 3 || !parts[0].trim() || !parts[1].trim() || !parts[2].trim()){
                showNotif("⚠️ QR tidak valid, silahkan scan ulang");
                return;
            }

            sudahAbsen = true;
            reader.stop();
            document.getElementById("scanStatus").innerText = "QR Terdeteksi ✅";

            const tanggal = new Date().toLocaleDateString();
            const nisQR = parts[0].trim();
            const namaQR = parts[1].trim();
            const kelasQR = parts[2].trim();
            const statusQR = parts[3]?.trim() || "Hadir";
            const ketQR = parts[4]?.trim() || "";

            let dataAbsensi = JSON.parse(localStorage.getItem("absensiAOS") || "[]");
            dataAbsensi.push({tanggal, nis: nisQR, nama: namaQR, kelas: kelasQR, status: statusQR, ket: ketQR});
            localStorage.setItem("absensiAOS", JSON.stringify(dataAbsensi));

            showSuccess();
            kunciForm();
        }
    );
}

// Ganti kamera saat dipilih user
document.getElementById("pilihKamera").onchange = (e) => {
    if(e.target.value) mulaiScan(e.target.value);
};

/* ===== Default value form manual ===== */
document.getElementById("manualId").value = "12345";
document.getElementById("manualNama").value = "Aku Hebat";
document.getElementById("manualKelas").value = "11";

/* ===== KIRIM MANUAL ===== */
document.getElementById("kirimManual").onclick = () => {
    if (sudahAbsen) return;

    const nis = document.getElementById("manualId").value.trim();
    const nama = document.getElementById("manualNama").value.trim();
    const kelas = document.getElementById("manualKelas").value.trim();
    const status = document.getElementById("manualStatus").value;
    const ket = document.getElementById("manualKet").value.trim();
    const tanggal = new Date().toLocaleDateString();

    if (!nis || !nama || !kelas) {
        showNotif("⚠️ Silahkan mengisi semua form terlebih dahulu");
        return;
    }

    let dataAbsensi = JSON.parse(localStorage.getItem("absensiAOS") || "[]");
    dataAbsensi.push({ tanggal, nis, nama, kelas, status, ket });
    localStorage.setItem("absensiAOS", JSON.stringify(dataAbsensi));

    sudahAbsen = true;
    showSuccess();
    kunciForm();
};

/* ===== BACK BUTTON ===== */
document.getElementById("backBtn").onclick = () => {
    window.location.href = "index.html"; 
};
</script>
</body>
</html>
